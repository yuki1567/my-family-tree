# テストガイド

## テスト戦略概要

フルスタック構成（フロントエンド + バックエンド）に適した包括的なテスト戦略を採用。

> **テスト規約**: `.claude/rules/backend/testing.md`, `.claude/rules/frontend/testing.md` を参照
> **テスト実装例**: `apps/backend/tests/`, `apps/frontend/tests/`

### テスト構成比率

| アプリ | テスト種別 | 比率 | 主な対象 |
|--------|-----------|------|---------|
| バックエンド | 統合テスト | 60% | APIエンドポイント（全レイヤー + DB連携） |
| バックエンド | 単体テスト | 40% | Service層、Zodバリデーション、ユーティリティ |
| フロントエンド | 単体テスト | 70% | コンポーネント、Composables、Store、ユーティリティ |
| フロントエンド | 結合テスト | 30% | 機能レベル（複数コンポーネント + 状態管理の連携） |

## 使用ツールの選定理由

### Vitest（フロントエンド・バックエンド共通）

| 観点 | Vitest | Jest |
|------|--------|------|
| ESM対応 | ネイティブサポート | 追加設定必要 |
| 起動速度 | 高速（Vite） | 遅い |
| TypeScript | 追加設定不要 | ts-jest必要 |
| Vue SFC | ネイティブサポート | 追加設定必要 |

バックエンドでも採用する理由: フロントエンドとの統一で学習コスト削減、Honoの`app.request()`との連携良好、`vi.fn()`/`vi.mock()`でJestと同等のモック機能提供

### Vue Test Utils

Vue.js公式コンポーネントテストライブラリ。Composition API完全対応。

### Happy DOM

jsdomより2-3倍高速。メモリ使用量も削減。Vitestとの組み合わせで最適なパフォーマンス。

## 統合テスト設計原則

### バックエンド統合テスト

**目的**: API全体の疎通確認。詳細なバリデーションは単体テストに委譲。

**検証すべき内容**:
- API疎通（HTTPリクエスト/レスポンスの正常動作）
- レイヤー間連携（Route → Service → Repository → DB）
- 代表的なエラーパターン（主要エラー1つずつ）
- データ永続化（DB状態検証）

**検証すべきでない内容**:
- 全パターンのバリデーションエラー → 単体テスト
- エッジケース・境界値 → 単体テスト

### フロントエンド統合テスト

**目的**: ページレベルの動作確認。

**検証すべき内容**:
- ページレンダリング（レイアウト + コンポーネント）
- ルーティング・パラメータ受け渡し
- API連携（データ取得・更新フロー）
- 主要ユーザーインタラクション

### 並列実行とデータ競合の設計判断

統合テストは必ず直列実行（`singleThread: true`）。理由: Vitestはデフォルト並列実行だが、各テスト前の`db.delete()`が他テストの実行中データを削除するデータ競合が発生する。

- 統合テスト: 直列実行 + 各テスト前にクリーンアップ
- 単体テスト: モック使用で並列実行可能

## テスト用データベースセットアップ

### マイグレーション実行タイミング

マイグレーションはVitest GlobalSetupで自動実行（DB接続確認 + リトライ機能付き）。テスト実行中のスキーマ変更はないため、毎回のマイグレーションは不要。

> **実ファイル参照**: `apps/backend/tests/setup/globalSetup.ts`

### DB検証の設計原則

統合テストでは**APIレスポンス + DB状態の両方**を検証する理由：

1. APIが成功レスポンスを返してもDB保存に失敗する可能性
2. Repository層の実際のSQL実行とDrizzle ORMマッピングの検証
3. API形式とDB保存形式の変換処理確認

**推奨パターン**: 作成IDを使った検証（全件検索は非効率）

## テスト用Docker構成

### Profilesによる環境分離

同一`docker-compose.yml`内でprofilesを使用してテスト環境を分離。

| プロファイル | 起動サービス | 用途 |
|-------------|-------------|------|
| なし（デフォルト） | apps + db | 通常開発 |
| test | apps + db + test-db | テスト実行 |

**test-dbの設計判断**:
- `tmpfs`でメモリ上実行（高速化）
- ポート5433で開発用DBと分離
- profiles指定により誤起動を防止

### テスト実行の流れ

1. テスト用DB起動: `docker compose --profile test up test-db -d`
2. テスト実行: `docker compose exec apps npm run test --workspace=apps/backend`
3. 開発セッション終了時のみ停止: `docker compose stop test-db`

モノレポ構造のため、backendワークスペース内で実行が必要。

## テスト設計原則

1. **テスト独立性**: 各テストは他のテストに依存しない
2. **現実的なデータ**: 実際の使用ケースを反映したテストデータ
3. **境界値テスト**: バリデーションの境界条件を重点的にテスト（単体テスト）
4. **エラーファースト**: 正常系と異常系の両方を必ずテスト
5. **データ整合性**: DB状態の検証を含むテスト（統合テスト）

### カバレッジについて

カバレッジは品質の指標の一つだが絶対的な目標ではない。重要な機能のビジネスロジック・APIを十分にテストし、リスクベースで障害影響が大きい部分を重点的にテスト。

## テストフォルダ構成

バックエンド・フロントエンドで統一された構成を採用。ファイル命名は`*.test.ts`で統一。

> **実ファイル参照**: `apps/backend/tests/`, `apps/frontend/tests/`
